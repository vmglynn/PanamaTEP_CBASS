##Script used to run GenPipes on the Digital Research Alliance of Canada's High Performance Computing (HPC). Link to GenPipes DNA Sequencing Pipeline: https://genpipes.readthedocs.io/en/latest/user_guide/pipelines/gp_dnaseq.html

module load mugqic/genpipes/3.6.2 mugqic/python/2.7.14 

ls $MUGQIC_INSTALL_HOME/genomes/species

ls $MUGQIC_INSTALL_HOME/genomes/species/Pocillopora_damicornis.GCF_003704095.1

####Run in sanity check mode to make sure all files/dependencies needed are there

dnaseq.py -t mugqic -c $MUGQIC_PIPELINES_HOME/pipelines/dnaseq/dnaseq.base.ini $MUGQIC_PIPELINES_HOME/pipelines/dnaseq/dnaseq.cedar.ini /cvmfs/soft.mugqic/CentOS6/genomes/species/Pocillopora_damicornis.GCF_003704095.1/Pocillopora_damicornis.GCF_003704095.1.UCSC2019-08-07.ini -r FINAL_Readset_Pdam_GenPipes_6Dec2021_Francoisedit_v3.txt -s 2-7,9-17 --sanity-check --no-json --report > dnaseqCommands_fullsteps6Jan2022_mugqic.sh  

bash dnaseqCommands_fullsteps6Jan2022_mugqic.sh

## VCF statistics for downstream QC

### First let's preliminarily filter SNPs from GenPipes' vcf file on the basis of variant missingess (max-missing), minor allele count (MAC), and quality score (Q)  

#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=40
#SBATCH --mem=125G    
#SBATCH --account=def-barrett   
#SBATCH --time=02:00:00   
#SBATCH --output=%x-%j.out      
module load StdEnv/2020 gcc/9.3.0 r/4.0.2 vcftools  

vcftools --gzvcf allSamples.hc.vcf.gz --max-missing 0.5 --mac 3 --minQ 30 --recode --recode-INFO-all --out raw.g5mac3

### Now let's calculate key metrics for downstream visualization in our script, vcftools_CORALstatistics_25Feb2022.Rmd, (closely following  the page "Speciation & Population Genomics: a how-to-guide
" by Joana Meier & Mark Ravinet https://speciationgenomics.github.io/filtering_vcfs/)

#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=40
#SBATCH --mem=125G    
#SBATCH --account=def-barrett   
#SBATCH --time=06:00:00   
#SBATCH --output=%x-%j.out      
module load StdEnv/2020 gcc/9.3.0 r/4.0.2 vcftools  
module load StdEnv/2020 gcc/9.3.0 r/4.0.2 vcftools  

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz  --freq2 --out CORALsamples_allelefreq --max-alleles 2

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz  --depth --out CORALsamples_mindepth
 
vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz --site-mean-depth --out CORALsamples_site_mindepth

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz --site-quality --out CORALsamples_sitequal

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz --missing-indv --out CORALsamples_missindi

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz--missing-site --out CORALsamples_misssite

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz --het --out CORALsamples_het

###Based on the findings from our script vcftools_CORALstatistics_25Feb2022.Rmd, we then can filter our data further: 

!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=40
#SBATCH --mem=125G    
#SBATCH --account=def-barrett   
#SBATCH --time=06:00:00   
#SBATCH --output=%x-%j.out      
module load StdEnv/2020 gcc/9.3.0 r/4.0.2 vcftools 

vcftools --gzvcf coral_only_bcftools_24Feb2022.vcf.gz \
--remove-indels --maf 0.05 --minQ 30 --minDP 5 --maxDP 10 --max-missing  0.4 --recode --stdout  > coral_onlyFILTER_bcftools_19Sep2022.vcf

###Rename samples so each name is encoded as REEF_GULF_YEAR

#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=40
#SBATCH --mem=125G    
#SBATCH --account=def-barrett   
#SBATCH --time=01:00:00   
#SBATCH --output=%x-%j.out      
module load StdEnv/2020 gcc/9.3.0 bcftools/1.13 

bcftools reheader -s newnames_28Feb2022.txt -o coral_onlyFILTER_rename_19Sep2022.vcf  coral_onlyFILTER_bcftools_19Sep2022.vcf

### ADMIXTURE analyses for all samples today; I closely followed the tutorial by Tyler Smith: https://plantarum.ca/2021/06/01/admixture/

### I am using the vcf file with loci under linkage disequilibrium pruned, generated by the Rmd file CBASS_TEP_popgen_7July2024.Rmd. The vcf file is called vcf_pruned_final_13Feb2024.vcf

#### First create vcf > bed file for input to ADMIXTURE

#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=40
#SBATCH --mem=125G
#SBATCH --account=def-barrett
#SBATCH --time=00:30:00
#SBATCH --output=%x-%j.out
module --force purge
module load StdEnv/2020  plink/2.00-10252019-avx2

plink2 --vcf vcf_pruned_final_13Feb2024.vcf  --make-bed --out pruned_snps_15July2024 --allow-extra-chr 0 -max-alleles 2 --min-alleles 2

### Run ADMIXTURE with cross-validation (CV) step, for K number of clusters 1-12

#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=40
#SBATCH --mem=125G
#SBATCH --account=def-barrett
#SBATCH --time=02:00:00
#SBATCH --output=%x-%j.out
module --force purge
module load StdEnv/2020  plink/2.00-10252019-avx2


for K in `seq -w 1 12`
do
    admixture_linux-1.3.0/admixture --cv pruned_snps_15July2024.bed $K > ktests/k${K}.out
 
done

###Let's inspect the CV results

grep -h CV ktests/*out

### Save resulting CV concatenated file for use as a .csv file in ADMIXTURE Rmd script, CBASS_TEP_admixture_15July2024.Rmd. In this script, we explore patterns across reef sites in each gulf, alongside if the observed patterns segregate by mtORF lineage.
